---
const { bonus, advantage = false } = Astro.props;
const bonusSign = bonus >= 0 ? '+' : '';
const id = "check-cell-" + crypto.randomUUID();
---
<span id={id} class="mono check-cell" data-bonus={bonus} data-advantage={advantage}>
  <a class="regular-link" href="">{bonusSign}{bonus}</a>
  <a class="advantage-link" href="">{advantage ? <Fragment set:html={'<strong>ADV</strong>'} /> : 'ADV'}</a>
  <a class="disadvantage-link" href="">DIS</a>
</span>

<script is:inline define:vars={{ id, bonus }}>
  const rollOptions = {
    app: function (bonus, { advantage, disadvantage } = {}) {
      let suffix = ''
      if (advantage) {
        suffix = '(ADV)'
      } else if (disadvantage) {
        suffix = '(DIS)'
      }
      return `dice://roll/d20+${bonus}${suffix}`
    },
    site: function (bonus, { advantage, disadvantage } = {}) {
      let bonusSuffix = bonus != 0 ? `+${bonus}` : ''
      let roll = undefined
      if (advantage) {
        roll = '2d20max'
      } else if (disadvantage) {
        roll = '2d20min'
      } else {
        roll = 'd20'
      }
      return `https://dice.run/#/d/${roll}${bonusSuffix}`
    }
  };

  function updateLinks() {
    console.log("updateLinks")
    let diceApp = decodeURI(window.location.hash?.substring(1) ?? '');
    if (!rollOptions[diceApp]) { 
      diceApp = 'app';
    }
    const diceUrlFunction = rollOptions[diceApp];

    const cell = document.getElementById(id);
    if (cell) {
      const bonusLink = cell.querySelector('.regular-link');
      const advLink = cell.querySelector('.advantage-link');
      const disLink = cell.querySelector('.disadvantage-link');

      if (bonusLink) {
        bonusLink.href = diceUrlFunction(bonus);
      }
      if (advLink) {
        advLink.href = diceUrlFunction(bonus, { advantage: true });
      }
      if (disLink) {
        disLink.href = diceUrlFunction(bonus, { disadvantage: true });
      }
    }
  }

  document.addEventListener('DOMContentLoaded', updateLinks);
  window.addEventListener('hashchange', updateLinks, false);
</script>
