---
import { WeaponAttack, type WeaponAttackData, type DamageAddonData } from "./WeaponAttack.tsx";
import type { Character } from "../js/Character";
import { DiceString } from "../js/DiceString";

const { character } = Astro.props as { character: Character };

const weaponAttacks: WeaponAttackData[] = character.weapons.map((w) => {
  const damageModifier = character.abilityModifier("Str") + (w.bonus ?? 0);
  const baseDamage = DiceString.init(w.damage ?? "", damageModifier);

  const damageAddons: DamageAddonData[] = character.attackAddons.map((addon) => {
    const addonBaseDamage = DiceString.parse(addon.damage ?? "");

    return {
      addon: addon.addon,
      damage: {
        damageRoll: addonBaseDamage.normalize().toString(),
        critRoll: addonBaseDamage.crit().normalize().toString(),
      },
    };
  });

  return {
    weapon: w.weapon,
    attackModifier: character.abilityModifier("Str") + character.proficiencyBonus + (w.bonus ?? 0),
    damage: {
      damageRoll: baseDamage.normalize().toString(),
      critRoll: baseDamage.crit().normalize().toString(),
    },
    damageAddons,
  };
});
---

<WeaponAttack client:only="react" weaponAttacks={weaponAttacks} />
