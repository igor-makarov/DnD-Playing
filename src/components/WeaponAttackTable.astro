---
import { WeaponAttack, type WeaponAttackData, type DamageAddonData } from "./WeaponAttack.tsx";
import type { Character } from "../js/Character";
import { DiceString } from "../js/DiceString";

const { character } = Astro.props as { character: Character };

const weaponAttacks: WeaponAttackData[] = character.weapons.map((w) => {
  const damageWithAbility = DiceString.sum(w.damage, w.bonus ?? 0, character.abilityModifier(w.ability));

  return {
    weapon: w.weapon,
    attackModifier: (w.bonus ?? 0) + character.abilityModifier(w.ability) + character.proficiencyBonus,
    damage: {
      damageRoll: damageWithAbility.normalize().toString(),
      critRoll: damageWithAbility.crit().normalize().toString(),
    },
  };
});

const damageAddons: DamageAddonData[] = character.attackAddons.map((addon) => {
  const addonBaseDamage = DiceString.parse(addon.damage);

  return {
    addon: addon.addon,
    damage: {
      damageRoll: addonBaseDamage.normalize().toString(),
      critRoll: addonBaseDamage.crit().normalize().toString(),
    },
  };
});
---

<WeaponAttack client:only="react" weaponAttacks={weaponAttacks} damageAddons={damageAddons} />
