---
import ReferenceLayout from "@/layouts/ReferenceLayout.astro";
import { getClass, getClassFeaturesFull } from "@/js/utils/render-5etools/getClass";
import renderHTML from "@/js/utils/render-5etools/renderHTML";
import { collectAllClassReferences } from "@/js/utils/collectClassNames";

export function getStaticPaths() {
  const classRefs = collectAllClassReferences();
  return classRefs.map((ref) => ({
    params: { class: `${ref.name}-${ref.source}` },
    props: { className: ref.name, source: ref.source },
  }));
}

const { className, source } = Astro.props;

// Fetch class data from 5etools
const classData = getClass(className, source);

// Add class features grouped by level
const features = getClassFeaturesFull(className, source);
const byLevel = new Map<number, typeof features>();
for (const f of features) {
  if (!byLevel.has(f.level)) byLevel.set(f.level, []);
  byLevel.get(f.level)!.push(f);
}

for (const [level, levelFeatures] of byLevel) {
  for (const feature of levelFeatures) {
    classData.entries.push({ type: "heading", name: `Level ${level}: ${feature.name}` });
    classData.entries = [...classData.entries, ...feature.entries];
  }
}

delete classData.fullLink;
const { sanitizedHtml } = renderHTML(classData);
---

<ReferenceLayout frontmatter={{ title: className }}>
  <Fragment set:html={sanitizedHtml} />
</ReferenceLayout>
