---
import AbilitiesTable from "@/components/AbilitiesTable.astro";
import SkillsTable from "@/components/SkillsTable.astro";
import SavesTable from "@/components/SavesTable.astro";
import D20TestCell from "@/components/common/D20TestCell.tsx";
import HitPointsInput from "@/components/HitPointsInput.tsx";
import HitDiceTable from "@/components/HitDiceTable.tsx";
import SpellSlotsTables from "@/components/SpellSlotsTables.astro";
import InfoTooltip from "@/components/common/InfoTooltip.tsx";

import { Character } from "@/js/character/Character";
import { D20Test } from "@/js/common/D20Test";
import { DiceString } from "@/js/common/DiceString";
import { getClass } from "@/js/utils/render-5etools/getClass";
import { getClassFeature } from "@/js/utils/render-5etools/getClassFeature";
import { getFeat } from "@/js/utils/render-5etools/getFeat";
import { getSpecies } from "@/js/utils/render-5etools/getSpecies";
import { getSpell } from "@/js/utils/render-5etools/getSpell";
import renderHTML from "@/js/utils/render-5etools/renderHTML";
import "@/styles/style.css";

class AzuneCharacter extends Character {
  constructor() {
    super({
      abilityScores: {
        Str: 18,
        Dex: 14,
        Con: 16,
        Int: 12,
        Wis: 14,
        Cha: 18,
      },
      // Paladin 2 / Sorcerer 1 at level 3
      classLevels: [
        { className: "Paladin", level: 2 },
        { className: "Sorcerer", level: 1 },
      ],
      skillProficiencies: [],
      saveProficiencies: [
        { save: "Wis" }, // Paladin
        { save: "Cha" }, // Paladin
      ],
      hitPointRolls: [
        { level: 1, die: new DiceString("d10"), roll: 10 },
        { level: 2, die: new DiceString("d10"), roll: 6 },
        { level: 3, die: new DiceString("d6"), roll: 5 },
      ],
    });
  }

  // Spell Attack Modifier: Charisma modifier + Proficiency bonus
  getSpellAttack(): D20Test {
    return new D20Test("Attack Roll", "Cha", this.getAbilityModifier("Cha"), this.createProficiency(true));
  }

  // Spell Save DC: 8 + Proficiency bonus + Charisma modifier
  getSpellSaveDC(): number {
    return 8 + this.getSpellAttack().getBonus();
  }

  // Lay on Hands pool (5 HP per Paladin level)
  getLayOnHandsPool(): number {
    return this.getClassLevel("Paladin") * 5;
  }
}

const character = new AzuneCharacter();
const characterName = "Azune Nayar";
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{import.meta.env.DEV ? "[dev] " : ""}{characterName}</title>
    <base target="_blank" />
  </head>
  <body>
    <div class="row six-across">
      <AbilitiesTable character={character} />
    </div>
    <div class="row four-across">
      <div class="column">
        <table>
          <tr>
            <th style="text-align: center;">Proficiency Bonus</th>
          </tr>
          <tr>
            <td class="modifier" style="text-align: center;">
              <span class="mono">+{character.proficiencyBonus}&nbsp;</span>
            </td>
          </tr>
        </table>
      </div>
      <div class="column">
        <table>
          <tr>
            <th style="text-align: center;">AC</th>
          </tr>
          <tr>
            <td style="text-align: center;">
              <span class="mono">20</span>
            </td>
          </tr>
        </table>
      </div>
      <div class="column">
        <table>
          <tr>
            <th style="text-align: center;">HP</th>
          </tr>
          <tr>
            <td style="text-align: center;">
              <HitPointsInput client:load hitPointMaximum={character.getHitPoints()} hitDiceByType={character.getHitDice()} />
            </td>
          </tr>
        </table>
      </div>
      <div class="column">
        <table>
          <tr>
            <th style="text-align: center;">Initiative</th>
          </tr>
          <tr>
            <td class="modifier" style="text-align: center;">
              <span class="checkCell">
                <D20TestCell client:load roll={character.getInitiative()} />
              </span>
            </td>
          </tr>
        </table>
      </div>
    </div>

    <div class="row three-and-large">
      <div class="column">
        <SkillsTable title="Skills" character={character} />
      </div>
      <div class="column">
        <SavesTable title="Saves" character={character} />
        <HitDiceTable client:load hitDice={character.getHitDice()} conModifier={character.getAbilityModifier("Con")} />
      </div>
      <div class="column">
        <table>
          <tbody>
            <tr>
              <th colspan="2" style="text-align: center;">Spells</th>
            </tr>
            <tr>
              <td>Spell Attack Modifier</td>
              <td class="checkCell mono">
                <D20TestCell client:load roll={character.getSpellAttack()} />
              </td>
            </tr>
            <tr>
              <td>Spell Save DC</td>
              <td class="checkCell mono">
                <span class="mono">{character.getSpellSaveDC()}</span>
              </td>
            </tr>
            <tr>
              <th>Cantrips</th>
              <th class="modifier">Source</th>
            </tr>
            <tr>
              <td><InfoTooltip client:load reference={renderHTML(getSpell("Guidance"))}>Guidance</InfoTooltip></td>
              <td class="modifier">Paladin/Sorcerer</td>
            </tr>
            <tr>
              <td><InfoTooltip client:load reference={renderHTML(getSpell("Mending"))}>Mending</InfoTooltip></td>
              <td class="modifier">Sorcerer</td>
            </tr>
            <tr>
              <td><InfoTooltip client:load reference={renderHTML(getSpell("Message"))}>Message</InfoTooltip></td>
              <td class="modifier">Sorcerer</td>
            </tr>
            <tr>
              <th>1st Level Spells</th>
              <th class="modifier">Effect</th>
            </tr>
            <tr>
              <td><InfoTooltip client:load reference={renderHTML(getSpell("Detect Magic"))}>Detect Magic</InfoTooltip></td>
              <td class="modifier">ritual, sense magic</td>
            </tr>
            <tr>
              <td><InfoTooltip client:load reference={renderHTML(getSpell("False Life"))}>False Life</InfoTooltip></td>
              <td class="modifier">temp HP</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="column features">
        <SpellSlotsTables character={character} />
        <table>
          <tr>
            <th colspan="2" style="text-align: center;">Features</th>
          </tr>
          <tr>
            <th>Feature</th>
            <th class="modifier">Effect</th>
          </tr>
          <tr>
            <td>Species</td>
            <td class="modifier"><InfoTooltip client:load reference={renderHTML(getSpecies("Human"))}>Human</InfoTooltip></td>
          </tr>
          <tr>
            <td>Class</td>
            <td class="modifier">
              <InfoTooltip client:load reference={renderHTML(getClass("Paladin"))}>Paladin</InfoTooltip> 2 /
              <InfoTooltip client:load reference={renderHTML(getClass("Sorcerer"))}>Sorcerer</InfoTooltip> 1
            </td>
          </tr>
          <tr>
            <td>[Human] Resourceful</td>
            <td class="modifier">Heroic Inspiration on long rest</td>
          </tr>
          <tr>
            <td>[Human] Skillful</td>
            <td class="modifier">+1 skill proficiency</td>
          </tr>
          <tr>
            <td>[Human] Versatile</td>
            <td class="modifier">Origin feat</td>
          </tr>
          <tr>
            <td><InfoTooltip client:load reference={renderHTML(getFeat("Lucky"))}>[Feat] Lucky</InfoTooltip></td>
            <td class="modifier">reroll d20s</td>
          </tr>
          <tr>
            <td><InfoTooltip client:load reference={renderHTML(getClassFeature("Lay on Hands", "Paladin"))}>[Paladin] Lay on Hands</InfoTooltip></td>
            <td class="modifier">pool: <span class="mono">{character.getLayOnHandsPool()}</span> HP</td>
          </tr>
          <tr>
            <td
              ><InfoTooltip client:load reference={renderHTML(getClassFeature("Fighting Style", "Paladin"))}>[Paladin] Fighting Style</InfoTooltip
              ></td
            >
            <td class="modifier">Defense (+1 AC)</td>
          </tr>
          <tr>
            <td
              ><InfoTooltip client:load reference={renderHTML(getClassFeature("Innate Sorcery", "Sorcerer"))}>[Sorcerer] Innate Sorcery</InfoTooltip
              ></td
            >
            <td class="modifier">bonus action, adv on spell attacks</td>
          </tr>
        </table>
      </div>
    </div>
  </body>
</html>
