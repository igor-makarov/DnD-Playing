---
import ReferenceLayout from "@/layouts/ReferenceLayout.astro";
import { getSubclass, getSubclassFeaturesFull } from "@/js/utils/render-5etools/getSubclass";
import renderHTML from "@/js/utils/render-5etools/renderHTML";
import { collectAllSubclassReferences } from "@/js/utils/collectSubclassNames";

export function getStaticPaths() {
  const subclassRefs = collectAllSubclassReferences();
  return subclassRefs.map((ref) => ({
    params: { subclass: `${ref.className}-${ref.classSource}-${ref.subclassShortName}-${ref.subclassSource}` },
    props: {
      className: ref.className,
      classSource: ref.classSource,
      subclassShortName: ref.subclassShortName,
      subclassSource: ref.subclassSource,
    },
  }));
}

const { className, classSource, subclassShortName, subclassSource } = Astro.props;

// Fetch subclass data from 5etools
const subclassData = getSubclass(className, subclassShortName, classSource);

// Add subclass features grouped by level (skip intro feature which is already shown)
const features = getSubclassFeaturesFull(className, subclassShortName, classSource, subclassSource);
const byLevel = new Map<number, typeof features>();
for (const f of features) {
  // Skip intro feature (same name as subclass)
  if (f.name === subclassData.name) continue;
  if (!byLevel.has(f.level)) byLevel.set(f.level, []);
  byLevel.get(f.level)!.push(f);
}

for (const [level, levelFeatures] of byLevel) {
  for (const feature of levelFeatures) {
    subclassData.entries.push({ type: "heading", name: `Level ${level}: ${feature.name}` });
    subclassData.entries = [...subclassData.entries, ...feature.entries];
  }
}

delete subclassData.fullLink;
const { sanitizedHtml } = renderHTML(subclassData);
---

<ReferenceLayout frontmatter={{ title: subclassData.name }}>
  <Fragment set:html={sanitizedHtml} />
</ReferenceLayout>
